<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - API Configuration</title>
    <link rel="stylesheet" href="/css/shared-theme.css">
    <link rel="stylesheet" href="/dashboard/css/styles.css">
    <link rel="stylesheet" href="/dashboard/css/navigation.css">
    <link rel="stylesheet" href="/css/modern-enhancements.css">
    <style>
        .settings-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .settings-header {
            margin-bottom: var(--spacing-xl);
            text-align: center;
        }

        .settings-header h1 {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .settings-header p {
            color: var(--text-secondary);
            font-size: var(--font-size-base);
        }

        /* Accordion System */
        .accordion {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: var(--spacing-md);
            box-shadow: 0 2px 8px var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .accordion:hover {
            box-shadow: 0 4px 12px var(--shadow);
        }

        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
            border-bottom: 1px solid transparent;
        }

        .accordion-header:hover {
            background: var(--bg-card-hover);
        }

        .accordion-header.active {
            border-bottom-color: var(--border-color);
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .accordion-title-icon {
            font-size: 1.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .accordion-badge {
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .accordion-chevron {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .accordion-header.active .accordion-chevron {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 1.5rem;
        }

        .accordion-content.active {
            max-height: 5000px;
            padding: 1.5rem;
        }

        .settings-section {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-bottom: 0;
            box-shadow: none;
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .section-title svg {
            width: 20px;
            height: 20px;
        }

        .api-key-card {
            background: var(--card-bg, #f8f9fa);
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .api-key-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .api-key-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .api-key-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .api-key-title h3 {
            margin: 0;
            font-size: 1.125rem;
            color: var(--text-primary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-badge.configured {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.not-configured {
            background: #f8d7da;
            color: #721c24;
        }

        .api-key-value {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .key-display {
            flex: 1;
            background: var(--input-bg, #fff);
            border: 1px solid var(--border-color, #ced4da);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .key-display.hidden {
            letter-spacing: 0.2em;
        }

        .key-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-icon:active {
            transform: translateY(0);
        }

        .btn-icon.secondary {
            background: #6c757d;
        }

        .btn-icon.secondary:hover {
            background: #5a6268;
        }

        .btn-icon.success {
            background: #28a745;
        }

        .btn-icon svg {
            width: 16px;
            height: 16px;
        }

        .api-key-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }


        .copy-feedback {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #28a745;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .copy-feedback.show {
            opacity: 1;
            transform: translateY(0);
        }

        .copy-feedback svg {
            width: 20px;
            height: 20px;
        }

        .rate-limit-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .info-card {
            background: var(--card-bg, #f8f9fa);
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 8px;
            padding: 1rem;
        }

        .info-card-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .info-card-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .skeleton-loader {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            height: 20px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .api-key-form-container {
            padding: 1.5rem;
            background: var(--bg-secondary, #f8f9fa);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .api-key-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .input-with-button {
            display: flex;
            gap: 0.5rem;
            align-items: stretch;
        }

        .api-key-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
            background: var(--input-bg, #ffffff);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--accent-primary, #0099ff);
            box-shadow: 0 0 0 3px rgba(0, 153, 255, 0.1);
        }

        .btn-toggle-visibility {
            padding: 0.75rem;
            background: var(--bg-card, #ffffff);
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-toggle-visibility:hover {
            background: var(--bg-card-hover, #f0f4f8);
        }

        .btn-toggle-visibility svg {
            width: 18px;
            height: 18px;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .btn-save-key {
            padding: 0.75rem 1.5rem;
            background: var(--accent-primary, #0099ff);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-save-key:hover {
            background: var(--accent-hover, #0088ee);
            transform: translateY(-1px);
        }

        .btn-save-key:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-save-key svg {
            width: 16px;
            height: 16px;
        }

        .btn-get-key {
            padding: 0.75rem 1.5rem;
            background: transparent;
            color: var(--accent-primary, #0099ff);
            border: 1px solid var(--accent-primary, #0099ff);
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-get-key:hover {
            background: var(--accent-primary, #0099ff);
            color: white;
        }

        .btn-get-key svg {
            width: 16px;
            height: 16px;
        }

        /* Logo Upload Styles - Compact */
        .logo-upload-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .logo-preview-section {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .logo-preview {
            width: 120px;
            height: 120px;
            min-width: 120px;
            min-height: 120px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg);
            padding: 0.5rem;
            flex-shrink: 0;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .logo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }

        .logo-placeholder svg {
            width: 32px;
            height: 32px;
            opacity: 0.5;
        }

        .logo-placeholder p {
            margin: 0;
            font-size: 0.75rem;
        }

        .logo-info {
            flex: 1;
            padding: 0.75rem;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .logo-status {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .logo-status.success {
            color: #28a745;
        }

        .logo-status.error {
            color: #dc3545;
        }

        .logo-upload-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .upload-label {
            cursor: pointer;
        }

        .upload-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--accent-color, #007bff);
            color: white;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .upload-button:hover {
            background: var(--accent-hover, #0056b3);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .upload-button svg {
            width: 16px;
            height: 16px;
        }

        .upload-submit-btn {
            padding: 0.5rem 1rem;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .upload-submit-btn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .upload-submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .upload-hint {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Base Keywords Styles */
        .base-keywords-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.25rem;
            max-width: 900px;
        }

        .keywords-field-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .keywords-field-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--accent-primary);
        }

        .keywords-field-label-icon {
            font-size: 1rem;
            opacity: 0.8;
        }

        .keywords-textarea {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--input-bg, #ffffff);
            color: var(--text-primary);
            resize: vertical;
            min-height: 60px;
            max-height: 120px;
            transition: all 0.2s ease;
            line-height: 1.5;
        }

        .keywords-textarea:focus {
            outline: none;
            border-color: var(--accent-primary, #0099ff);
            box-shadow: 0 0 0 3px rgba(0, 153, 255, 0.1);
        }

        body.dark-mode .keywords-textarea {
            background: var(--input-bg, #1e293b);
            border-color: var(--border-color, #334155);
        }

        @media (max-width: 768px) {
            .base-keywords-form {
                grid-template-columns: 1fr;
            }
        }

        /* API Keys Grouping */
        .api-keys-groups {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .api-keys-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .api-keys-group-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .api-keys-group-llm {
            background: rgba(0, 153, 255, 0.03);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 153, 255, 0.1);
        }

        .api-keys-group-third-party {
            background: rgba(108, 117, 125, 0.03);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(108, 117, 125, 0.1);
        }

        /* Security Notice in API Keys */
        .security-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

        body.dark-mode .security-notice {
            background: rgba(255, 193, 7, 0.15);
            border-color: #ffc107;
        }

        .security-notice svg {
            width: 20px;
            height: 20px;
            color: #856404;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        body.dark-mode .security-notice svg {
            color: #ffc107;
        }

        .security-notice-content {
            flex: 1;
        }

        .security-notice-content strong {
            display: block;
            color: #856404;
            margin-bottom: 0.35rem;
        }

        body.dark-mode .security-notice-content strong {
            color: #ffc107;
        }

        .security-notice-content p {
            margin: 0;
            color: #856404;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        body.dark-mode .security-notice-content p {
            color: #ffc107;
        }

        /* Rate Limiting Explanation */
        .rate-limit-explanation {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--accent-primary);
        }

        .rate-limit-explanation h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .rate-limit-explanation p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .rate-limit-example {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* Appearance Section */
        .appearance-options {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .appearance-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .appearance-option-label {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .appearance-option-label strong {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .appearance-option-label span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .appearance-toggle {
            position: relative;
            width: 50px;
            height: 28px;
            background: var(--border-color);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .appearance-toggle.active {
            background: var(--accent-primary);
        }

        .appearance-toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .appearance-toggle.active::after {
            transform: translateX(22px);
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .btn-modal {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .btn-modal-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-modal-primary:hover {
            background: var(--accent-hover);
        }

        .btn-modal-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-modal-secondary:hover {
            background: var(--bg-card-hover);
        }

        .email-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .email-tag {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .email-tag-remove {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .email-tag-remove:hover {
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .settings-container {
                padding: var(--spacing-md);
            }

            .accordion-header {
                padding: 1rem;
            }

            .accordion-content.active {
                padding: 1rem;
            }

            .api-keys-groups {
                gap: 1rem;
            }

            .modal {
                width: 95%;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body class="has-nav-menu">
    <!-- Navigation Menu -->
    <nav class="nav-menu">
        <div class="nav-menu-left">
            <a href="/dashboard" class="nav-logo">
                <img src="" alt="OVHcloud" class="ovh-logo" style="width: 40px; height: 40px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1)); display: none;" onerror="this.style.display='none';">
                <svg class="ovh-logo" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                    <circle cx="60" cy="60" r="55" fill="none" stroke="#123f6d" stroke-width="4"/>
                    <path d="M 35 60 Q 60 35, 85 60 Q 60 85, 35 60" fill="#123f6d"/>
                    <path d="M 25 60 Q 35 50, 45 60 Q 55 70, 65 60 Q 75 50, 85 60 Q 95 70, 105 60" 
                          stroke="#00d4ff" stroke-width="3" fill="none" stroke-linecap="round"/>
                </svg>
                <span>Customer Feedbacks Tracker</span>
            </a>
            <div class="nav-tabs">
                <a href="/dashboard" class="nav-tab">
                    <span class="nav-tab-icon">üìä</span>
                    <span>Dashboard Analytics</span>
                </a>
                <a href="/improvements" class="nav-tab">
                    <span class="nav-tab-icon">üí°</span>
                    <span>Improvements Opportunities</span>
                </a>
                <a href="/scraping" class="nav-tab">
                    <span class="nav-tab-icon">üì•</span>
                    <span>Feedbacks Collection</span>
                </a>
                <a href="/logs" class="nav-tab">
                    <span class="nav-tab-icon">üìã</span>
                    <span>Scraping Logs</span>
                </a>
                <a href="/settings" class="nav-tab active">
                    <span class="nav-tab-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
                <a href="#" class="nav-tab" onclick="event.preventDefault(); window.toggleHelpMenu(); return false;">
                    <span class="nav-tab-icon">‚ùì</span>
                    <span>Help</span>
                </a>
            </div>
        </div>
        <div class="nav-menu-right">
            <span class="beta-badge" title="Application en version beta">BETA</span>
            <span class="version-badge" id="versionBadge" title="Application version">v1.0.1</span>
            <button class="theme-toggle" id="themeToggleBtn" title="Toggle theme">üåì</button>
        </div>
    </nav>

    <div class="settings-container">
        <!-- Header -->
        <div class="settings-header">
            <h1>Settings</h1>
            <p>Configure your application</p>
        </div>

        <!-- Section 1: LLM (Priorit√© Haute) -->
        <div class="accordion" data-accordion="llm">
            <div class="accordion-header" onclick="toggleAccordion('llm')">
                <div class="accordion-title">
                    <span class="accordion-title-icon">ü§ñ</span>
                    <span>LLM Configuration</span>
                    <span class="accordion-badge" id="llmBadge">--</span>
                </div>
                <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div class="accordion-content">
                <div class="settings-section">
                    <div id="llmStatusContainer" style="margin-bottom: 1.5rem;">
                        <!-- LLM Status will be rendered here -->
                    </div>

                    <div id="llmContainer">
                        <!-- Loading skeleton -->
                        <div class="api-key-card">
                            <div class="skeleton-loader"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Email Notifications -->
        <div class="accordion" data-accordion="email-notifications">
            <div class="accordion-header" onclick="toggleAccordion('email-notifications')">
                <div class="accordion-title">
                    <span class="accordion-title-icon">üìß</span>
                    <span>Email Notifications</span>
                    <span class="accordion-badge" id="emailNotificationsBadge">--</span>
                </div>
                <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div class="accordion-content">
                <div class="settings-section">
                    <!-- Email Configuration Status -->
                    <div id="emailConfigStatus" style="margin-bottom: 1.5rem;">
                        <!-- Email config status will be rendered here -->
                    </div>

                    <!-- Explanation -->
                    <div style="background: #e7f3ff; border-left: 4px solid #0099ff; padding: 1rem; border-radius: 6px; margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #004085; font-size: 1rem;">üí° How it works</h4>
                        <p style="margin: 0; color: #004085; font-size: 0.9em; line-height: 1.6;">
                            <strong>Notification triggers</strong> automatically send emails when problematic posts are detected.
                            Configure rules (negative sentiment, relevance score, sources, etc.) and emails will be sent to the addresses you specify.
                        </p>
                    </div>

                    <!-- Notification Triggers -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0;">
                                Notification Triggers
                            </h3>
                            <button onclick="openTriggerModal()" class="btn primary" style="padding: 0.5rem 1rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                + Add Trigger
                            </button>
                        </div>
                        <div id="triggersContainer">
                            <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Loading...</p>
                        </div>
                    </div>

                    <!-- Email Configuration & Test -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem;">
                            Test Email Sending
                        </h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9em; line-height: 1.6;">
                            Test your SMTP configuration by sending a test email. Make sure SMTP settings are configured in your <code style="background: var(--bg-secondary); padding: 0.2rem 0.4rem; border-radius: 4px;">.env</code> file.
                        </p>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <input type="email" id="testEmailInput" placeholder="email@example.com" style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9em;">
                            <button onclick="testEmailConnection()" class="btn primary" style="padding: 0.5rem 1rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Send Test Email
                            </button>
                        </div>
                    </div>

                    <!-- Notification History -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem;">
                            Notification History
                        </h3>
                        <div id="notificationsHistory">
                            <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Scrapers API Keys (Priorit√© Haute) -->
        <div class="accordion" data-accordion="scrapers-api-keys">
            <div class="accordion-header" onclick="toggleAccordion('scrapers-api-keys')">
                <div class="accordion-title">
                    <span class="accordion-title-icon">üîë</span>
                    <span>Scrapers API Keys</span>
                    <span class="accordion-badge" id="scrapersApiKeysBadge">--</span>
                </div>
                <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div class="accordion-content">
                <div class="settings-section">
                    <!-- Security Notice -->
                    <div class="security-notice">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <div class="security-notice-content">
                            <strong>Security Notice</strong>
                            <p>API keys are sensitive credentials. Never share them publicly or commit them to version control. 
                               The "Reveal" button temporarily shows the full key for copying - use it carefully and only when needed.</p>
                        </div>
                    </div>

                    <div id="scrapersApiKeysContainer">
                        <!-- Loading skeleton -->
                        <div class="api-key-card">
                            <div class="skeleton-loader"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Base Keywords (Priorit√© Haute) -->
        <div class="accordion" data-accordion="keywords">
            <div class="accordion-header" onclick="toggleAccordion('keywords')">
                <div class="accordion-title">
                    <span class="accordion-title-icon">üîç</span>
                    <span>Base Keywords</span>
                </div>
                <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div class="accordion-content">
                <div class="settings-section">
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6;">
                        These keywords are always used for scraping, even if you don't add custom keywords. 
                        They include OVH brands, products, common problems, and leadership mentions. 
                        You can modify them here, but they will always be included in scraping operations.
                    </p>

                    <div id="baseKeywordsContainer">
                        <!-- Loading skeleton -->
                        <div class="api-key-card">
                            <div class="skeleton-loader"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Rate Limiting (Priorit√© Basse - Am√©liorer l'explication) -->
        <div class="accordion" data-accordion="rate-limiting">
            <div class="accordion-header" onclick="toggleAccordion('rate-limiting')">
                <div class="accordion-title">
                    <span class="accordion-title-icon">‚è±Ô∏è</span>
                    <span>Rate Limiting</span>
                </div>
                <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div class="accordion-content">
                <div class="settings-section">
                    <!-- Improved explanation -->
                    <div class="rate-limit-explanation">
                        <h3>What is Rate Limiting?</h3>
                        <p>
                            Rate limiting limits the number of API requests per minute to avoid exceeding quotas and protect against abuse.
                            These settings control the frequency of API calls during scraping.
                        </p>
                        <p>
                            <strong>Why is it important?</strong><br>
                            External APIs (GitHub, Trustpilot, etc.) impose limits on the number of requests you can make.
                            Without rate limiting, you risk exceeding these limits and having your requests temporarily blocked.
                        </p>
                        <div class="rate-limit-example">
                            <strong>Example:</strong> 100 requests per 60 seconds = maximum 1.67 requests/second
                        </div>
                    </div>

                    <div class="rate-limit-info" id="rateLimitInfo">
                        <div class="info-card">
                            <div class="info-card-label">Requests per Window</div>
                            <div class="info-card-value">--</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-label">Window Duration</div>
                            <div class="info-card-value">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: Apparence (Priorit√© Basse) -->
        <div class="accordion" data-accordion="appearance">
            <div class="accordion-header" onclick="toggleAccordion('appearance')">
                <div class="accordion-title">
                    <span class="accordion-title-icon">üé®</span>
                    <span>Apparence</span>
                </div>
                <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div class="accordion-content">
                <div class="settings-section">
                    <div class="appearance-options">
                        <div class="appearance-option">
                            <div class="appearance-option-label">
                                <strong>Dark Mode</strong>
                                <span>Toggle between light and dark theme</span>
                            </div>
                            <div class="appearance-toggle" id="themeToggle" onclick="toggleThemeFromSettings()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logo Upload Section -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem;">
                            OVHcloud Logo
                        </h3>
                        <div class="logo-upload-container">
                            <div class="logo-preview-section">
                                <div class="logo-preview">
                                    <img id="logoPreview" src="" alt="OVHcloud Logo" style="display: none;" onerror="this.style.display='none'; document.getElementById('logoPlaceholder').style.display='flex';">
                                    <div id="logoPlaceholder" class="logo-placeholder" style="display: flex;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                        <p>No logo</p>
                                    </div>
                                </div>
                                <div class="logo-info" id="logoInfo">
                                    <p class="logo-status">Chargement...</p>
                                </div>
                            </div>
                            <div class="logo-upload-form">
                                <label for="logoFileInput" class="upload-label">
                                    <input type="file" id="logoFileInput" accept=".svg,.png,.jpg,.jpeg" style="display: none;">
                                    <span class="upload-button">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="17 8 12 3 7 8"/>
                                            <line x1="12" y1="3" x2="12" y2="15"/>
                                        </svg>
                                        Choose File
                                    </span>
                                </label>
                                <button id="uploadLogoBtn" class="upload-submit-btn" disabled>
                                    <span class="btn-text">Upload Logo</span>
                                    <span class="btn-spinner" style="display:none;"></span>
                                </button>
                                <p class="upload-hint">
                                    Accepted formats: SVG (recommended), PNG, JPG, JPEG<br>
                                    Maximum size: 5MB
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 5: Environment & Version (Derni√®re section) -->
        <div class="accordion" data-accordion="environment">
            <div class="accordion-header" onclick="toggleAccordion('environment')">
                <div class="accordion-title">
                    <span class="accordion-title-icon">üåê</span>
                    <span>Environment & Version</span>
                </div>
                <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div class="accordion-content">
                <div class="settings-section">
                    <div id="environmentInfo">
                        <!-- Loading skeleton -->
                        <div class="skeleton-loader" style="height: 100px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Success Feedback -->
    <div class="copy-feedback" id="copyFeedback">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
        </svg>
        <span>API key copied to clipboard!</span>
    </div>

    <!-- Trigger Modal -->
    <div class="modal-overlay" id="triggerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Create Trigger</h3>
                <button class="modal-close" onclick="window.closeTriggerModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="triggerForm" onsubmit="window.saveTrigger(event); return false;">
                    <div class="form-group">
                        <label for="triggerName">Trigger Name *</label>
                        <input type="text" id="triggerName" required placeholder="e.g., Negative Trustpilot Posts">
                        <small>A descriptive name to identify this trigger</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="triggerSentiment">Sentiment *</label>
                            <select id="triggerSentiment" required>
                                <option value="all">All</option>
                                <option value="negative" selected>Negative</option>
                                <option value="positive">Positive</option>
                                <option value="neutral">Neutral</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="triggerRelevance">Minimum Relevance Score</label>
                            <input type="number" id="triggerRelevance" min="0" max="1" step="0.1" value="0.3">
                            <small>0.0 to 1.0 (default: 0.3)</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="triggerSources">Sources (optional)</label>
                        <input type="text" id="triggerSources" placeholder="e.g., Trustpilot, Reddit (comma-separated)">
                        <small>Leave empty for all sources. Examples: Trustpilot, Reddit, X/Twitter</small>
                    </div>

                    <div class="form-group">
                        <label for="triggerLanguage">Language (optional)</label>
                        <select id="triggerLanguage">
                            <option value="all">All</option>
                            <option value="fr">French</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="triggerEmails">Recipient Emails *</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="email" id="triggerEmailInput" placeholder="email@example.com" style="flex: 1;">
                            <button type="button" onclick="window.addEmail()" class="btn-modal btn-modal-secondary" style="white-space: nowrap;">Add</button>
                        </div>
                        <div id="emailTags" class="email-tags"></div>
                        <small>Add email addresses that will receive notifications</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="triggerCooldown">Cooldown between notifications (minutes)</label>
                            <input type="number" id="triggerCooldown" min="1" value="60">
                            <small>Prevents spam (default: 60 min)</small>
                        </div>
                        <div class="form-group">
                            <label for="triggerMaxPosts">Max posts per email</label>
                            <input type="number" id="triggerMaxPosts" min="1" max="50" value="10">
                            <small>Maximum number of posts included (default: 10)</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="triggerEnabled" checked>
                            <span>Enable this trigger</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="window.closeTriggerModal()" class="btn-modal btn-modal-secondary">Cancel</button>
                <button type="button" onclick="document.getElementById('triggerForm').dispatchEvent(new Event('submit', {cancelable: true}))" class="btn-modal btn-modal-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Help Menu -->
    <div class="help-menu" id="helpMenu">
        <div class="help-menu-header">
            <h2>üìñ Help & Information</h2>
            <button class="help-menu-close" onclick="window.toggleHelpMenu()">√ó</button>
        </div>
        <div class="help-menu-content">
            <!-- Content loaded dynamically by help-menu-loader.js -->
            <p style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading help content...</p>
        </div>
    </div>

    <script src="/js/help-menu-loader.js"></script>
    <script src="/dashboard/js/settings.js"></script>
    <script>
        // Logo Upload Functionality
        const API_BASE = window.location.origin;
        let selectedFile = null;

        // Check logo status on page load
        async function checkLogoStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/logo-status`);
                const data = await response.json();
                
                const logoInfo = document.getElementById('logoInfo');
                const logoPreview = document.getElementById('logoPreview');
                const logoPlaceholder = document.getElementById('logoPlaceholder');
                
                if (data.exists) {
                    logoInfo.innerHTML = `
                        <p class="logo-status success">
                            ‚úÖ Current logo: ${data.filename}<br>
                            <small>Size: ${(data.size / 1024).toFixed(2)} KB</small>
                        </p>
                    `;
                    if (logoPreview) {
                        logoPreview.src = data.path + '?t=' + Date.now(); // Cache bust
                        logoPreview.style.display = 'block';
                        if (logoPlaceholder) logoPlaceholder.style.display = 'none';
                    }
                } else {
                    logoInfo.innerHTML = `
                        <p class="logo-status">
                            ‚ÑπÔ∏è No logo uploaded.
                        </p>
                    `;
                    if (logoPreview) logoPreview.style.display = 'none';
                    if (logoPlaceholder) logoPlaceholder.style.display = 'flex';
                }
            } catch (error) {
                console.error('Error checking logo status:', error);
                const logoInfoEl = document.getElementById('logoInfo');
                if (logoInfoEl) {
                    logoInfoEl.innerHTML = `
                        <p class="logo-status error">‚ùå Error checking logo</p>
                    `;
                }
            }
        }

        // File input change handler
        const logoFileInput = document.getElementById('logoFileInput');
        if (logoFileInput) {
            logoFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    selectedFile = file;
                    const uploadBtn = document.getElementById('uploadLogoBtn');
                    if (uploadBtn) uploadBtn.disabled = false;
                    
                    // Preview image
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const logoPreview = document.getElementById('logoPreview');
                        const logoPlaceholder = document.getElementById('logoPlaceholder');
                        if (logoPreview) {
                            logoPreview.src = e.target.result;
                            logoPreview.style.display = 'block';
                        }
                        if (logoPlaceholder) logoPlaceholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Upload button click handler
        const uploadLogoBtn = document.getElementById('uploadLogoBtn');
        if (uploadLogoBtn) {
            uploadLogoBtn.addEventListener('click', async function() {
                if (!selectedFile) return;
                
                const btn = this;
                const btnText = btn.querySelector('.btn-text');
                const btnSpinner = btn.querySelector('.btn-spinner');
                
                btn.disabled = true;
                if (btnText) btnText.textContent = 'Uploading...';
                if (btnSpinner) btnSpinner.style.display = 'inline-block';
                
                try {
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    
                    const response = await fetch(`${API_BASE}/api/upload-logo`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // Show success message
                        const logoInfo = document.getElementById('logoInfo');
                        if (logoInfo) {
                            logoInfo.innerHTML = `
                                <p class="logo-status success">
                                    ‚úÖ ${data.message}<br>
                                    <small>Logo is now active</small>
                                </p>
                            `;
                        }
                        
                        // Update preview
                        const logoPreview = document.getElementById('logoPreview');
                        if (logoPreview) {
                            logoPreview.src = data.path + '?t=' + Date.now();
                            logoPreview.style.display = 'block';
                            logoPreview.onerror = function() {
                                this.style.display = 'none';
                                const placeholder = document.getElementById('logoPlaceholder');
                                if (placeholder) placeholder.style.display = 'flex';
                            };
                        }
                        const logoPlaceholder = document.getElementById('logoPlaceholder');
                        if (logoPlaceholder) logoPlaceholder.style.display = 'none';
                        
                        // Store in localStorage for other pages FIRST
                        localStorage.setItem('logoPath', data.path);
                        localStorage.setItem('logoUpdated', Date.now().toString());
                        
                        // Update logo in navigation across all pages - FORCE RELOAD
                        if (window.updateLogoInNavigation) {
                            // Force reload to replace old logo with new one
                            window.updateLogoInNavigation(data.path, true);
                        } else {
                            // If function not available, force reload logo-updater
                            const logoUpdaterScript = document.createElement('script');
                            logoUpdaterScript.src = '/js/logo-updater.js?t=' + Date.now();
                            logoUpdaterScript.onload = function() {
                                if (window.updateLogoInNavigation) {
                                    window.updateLogoInNavigation(data.path, true);
                                }
                            };
                            document.head.appendChild(logoUpdaterScript);
                        }
                        
                        // Re-check logo status to ensure it's saved and persisted
                        // Use longer delay to avoid conflict with checkLogoUpdate interval
                        setTimeout(() => {
                            // Force reload when checking status after upload
                            if (typeof checkLogoStatus === 'function') {
                                checkLogoStatus(true);
                            }
                            // Force update again after a short delay to ensure persistence - FORCE RELOAD
                            setTimeout(() => {
                                if (window.updateLogoInNavigation) {
                                    window.updateLogoInNavigation(data.path, true);
                                }
                            }, 1000);
                        }, 1500);
                        
                        // Reset form
                        if (logoFileInput) logoFileInput.value = '';
                        selectedFile = null;
                        btn.disabled = true;
                        
                        // Show toast notification
                        showToast('Logo uploaded successfully!', 'success');
                    } else {
                        throw new Error(data.detail || 'Error uploading logo');
                    }
                } catch (error) {
                    console.error('Error uploading logo:', error);
                    const logoInfo = document.getElementById('logoInfo');
                    if (logoInfo) {
                        logoInfo.innerHTML = `
                            <p class="logo-status error">‚ùå Error: ${error.message}</p>
                        `;
                    }
                    showToast('Error uploading logo', 'error');
                } finally {
                    if (btnText) btnText.textContent = 'Upload Logo';
                    if (btnSpinner) btnSpinner.style.display = 'none';
                }
            });
        }

        // Logo updater is handled by /js/logo-updater.js
        // The function window.updateLogoInNavigation is available globally

        // Simple toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `copy-feedback ${type}`;
            toast.textContent = message;
            toast.style.background = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff';
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkLogoStatus();
            loadEmailNotifications();
        });

        // ============================================================================
        // Email Notifications Management
        // ============================================================================
        const API_BASE = window.location.origin;

        async function loadEmailNotifications() {
            try {
                // Load email config
                const configRes = await fetch(`${API_BASE}/api/email/config`);
                if (configRes.ok) {
                    const config = await configRes.json();
                    const statusEl = document.getElementById('emailConfigStatus');
                    if (statusEl) {
                        statusEl.innerHTML = `
                            <div style="padding: 1rem; background: ${config.smtp_configured ? '#d4edda' : '#f8d7da'}; border-radius: 8px; border-left: 4px solid ${config.smtp_configured ? '#28a745' : '#dc3545'};">
                                <strong>${config.smtp_configured ? '‚úÖ SMTP Configured' : '‚ùå SMTP Not Configured'}</strong>
                                ${config.smtp_configured ? `
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9em; color: #155724;">
                                        Host: ${config.smtp_host || 'N/A'}<br>
                                        Port: ${config.smtp_port || 'N/A'}<br>
                                        From: ${config.smtp_from_email || 'N/A'}
                                    </p>
                                ` : '<p style="margin: 0.5rem 0 0 0; font-size: 0.9em; color: #721c24;">Configure SMTP in .env file</p>'}
                            </div>
                        `;
                    }
                } else {
                    const statusEl = document.getElementById('emailConfigStatus');
                    if (statusEl) {
                        statusEl.innerHTML = '<p style="color: #dc3545;">Error loading configuration</p>';
                    }
                }

                // Load triggers
                const triggersRes = await fetch(`${API_BASE}/api/email/triggers`);
                if (triggersRes.ok) {
                    const data = await triggersRes.json();
                    const triggers = Array.isArray(data) ? data : (data.triggers || []);
                    renderTriggers(triggers);
                    
                    // Update badge
                    const badge = document.getElementById('emailNotificationsBadge');
                    if (badge) {
                        const activeCount = triggers.filter(t => t.enabled).length;
                        badge.textContent = `${activeCount}/${triggers.length}`;
                    }
                } else {
                    const container = document.getElementById('triggersContainer');
                    if (container) {
                        container.innerHTML = '<p style="color: #dc3545;">Error loading triggers</p>';
                    }
                }

                // Load notification history
                const historyRes = await fetch(`${API_BASE}/api/email/notifications?limit=10`);
                if (historyRes.ok) {
                    const historyData = await historyRes.json();
                    // API returns {notifications: [...], total: ...}
                    const notifications = historyData.notifications || [];
                    renderNotificationHistory(notifications);
                } else {
                    const container = document.getElementById('notificationsHistory');
                    if (container) {
                        container.innerHTML = '<p style="color: #dc3545;">Error loading history</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading email notifications:', error);
                showToast('Error loading data', 'error');
            }
        }

        function renderTriggers(triggers) {
            const container = document.getElementById('triggersContainer');
            if (!container) return;

            if (triggers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No triggers configured. Click "Add Trigger" to create one.</p>';
                return;
            }

            container.innerHTML = triggers.map(trigger => {
                try {
                    const conditions = typeof trigger.conditions === 'string' ? JSON.parse(trigger.conditions || '{}') : (trigger.conditions || {});
                    const emails = typeof trigger.emails === 'string' ? JSON.parse(trigger.emails || '[]') : (trigger.emails || []);
                    const statusClass = trigger.enabled ? '#28a745' : '#ffc107';
                    const statusText = trigger.enabled ? 'Enabled' : 'Disabled';
                    const statusIcon = trigger.enabled ? '‚úÖ' : '‚è∏Ô∏è';

                    const sourcesText = conditions.sources && conditions.sources.length > 0 
                        ? conditions.sources.join(', ') 
                        : 'All sources';

                    const sentimentText = conditions.sentiment === 'negative' ? 'Negative' 
                        : conditions.sentiment === 'positive' ? 'Positive' 
                        : conditions.sentiment === 'neutral' ? 'Neutral' 
                        : 'All';

                    return `
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">${escapeHtml(trigger.name)}</h4>
                                    <span style="padding: 0.25rem 0.75rem; background: ${statusClass}; color: white; border-radius: 12px; font-size: 0.85em; font-weight: 500;">${statusIcon} ${statusText}</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button onclick="editTrigger(${trigger.id})" style="padding: 0.4rem 0.8rem; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Edit</button>
                                    <button onclick="toggleTrigger(${trigger.id}, ${!trigger.enabled})" style="padding: 0.4rem 0.8rem; background: ${trigger.enabled ? '#dc3545' : '#28a745'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">${trigger.enabled ? 'Disable' : 'Enable'}</button>
                                    <button onclick="deleteTrigger(${trigger.id})" style="padding: 0.4rem 0.8rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Delete</button>
                                </div>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.6;">
                                <div><strong>Conditions:</strong> Sentiment: ${sentimentText}, Relevance: ‚â•${(conditions.relevance_score_min || 0).toFixed(2)}, Sources: ${escapeHtml(sourcesText)}</div>
                                <div><strong>Emails:</strong> ${emails.map(e => escapeHtml(e)).join(', ') || 'None'}</div>
                                <div><strong>Cooldown:</strong> ${trigger.cooldown_minutes} minutes | <strong>Max posts:</strong> ${trigger.max_posts_per_email}</div>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error('Error rendering trigger:', e, trigger);
                    return '';
                }
            }).filter(Boolean).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderNotificationHistory(notifications) {
            const container = document.getElementById('notificationsHistory');
            if (!container) return;

            if (notifications.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">No notifications sent yet.</p>';
                return;
            }

            container.innerHTML = notifications.map(notif => {
                try {
                    const postIds = typeof notif.post_ids === 'string' ? JSON.parse(notif.post_ids || '[]') : (notif.post_ids || []);
                    const emails = typeof notif.recipient_emails === 'string' ? JSON.parse(notif.recipient_emails || '[]') : (notif.recipient_emails || []);
                    const statusClass = notif.status === 'sent' ? '#28a745' : '#dc3545';
                    const statusIcon = notif.status === 'sent' ? '‚úÖ' : '‚ùå';
                    const statusText = notif.status === 'sent' ? 'Sent' : 'Failed';

                    const date = notif.sent_at || notif.created_at;
                    const dateStr = date ? new Date(date).toLocaleString('en-US') : 'Unknown date';

                    return `
                        <div style="background: var(--bg-card); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid ${statusClass};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">${statusIcon} ${statusText}</div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 0.25rem;">
                                        ${postIds.length} post${postIds.length !== 1 ? 's' : ''} sent to ${emails.length} recipient${emails.length !== 1 ? 's' : ''}<br>
                                        ${dateStr}
                                        ${notif.error_message ? `<br><span style="color: #dc3545;">Error: ${escapeHtml(notif.error_message)}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error('Error rendering notification:', e, notif);
                    return '';
                }
            }).filter(Boolean).join('');
        }

        let currentTriggerId = null;
        let emailList = [];

        // Make functions globally available
        window.openTriggerModal = function(triggerId = null) {
            currentTriggerId = triggerId;
            const modal = document.getElementById('triggerModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('triggerForm');
            
            // Reset form
            form.reset();
            emailList = [];
            updateEmailTags();

            if (triggerId) {
                // Edit mode - load trigger data
                title.textContent = 'Edit Trigger';
                loadTriggerData(triggerId);
            } else {
                // Create mode
                title.textContent = 'Create Trigger';
                // Set defaults
                document.getElementById('triggerSentiment').value = 'negative';
                document.getElementById('triggerRelevance').value = '0.3';
                document.getElementById('triggerCooldown').value = '60';
                document.getElementById('triggerMaxPosts').value = '10';
                document.getElementById('triggerEnabled').checked = true;
            }

            modal.classList.add('active');
        };

        window.closeTriggerModal = function() {
            document.getElementById('triggerModal').classList.remove('active');
            currentTriggerId = null;
            emailList = [];
        };

        window.addEmail = function() {
            const input = document.getElementById('triggerEmailInput');
            const email = input.value.trim();
            
            if (!email) return;
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Invalid email address', 'error');
                return;
            }

            if (emailList.includes(email)) {
                showToast('This email is already added', 'error');
                return;
            }

            emailList.push(email);
            input.value = '';
            updateEmailTags();
        };

        window.removeEmail = function(email) {
            emailList = emailList.filter(e => e !== email);
            updateEmailTags();
        };

        async function loadTriggerData(triggerId) {
            try {
                const res = await fetch(`${API_BASE}/api/email/triggers/${triggerId}`);
                if (!res.ok) throw new Error('Error loading trigger');
                
                const trigger = await res.json();
                const conditions = typeof trigger.conditions === 'string' ? JSON.parse(trigger.conditions) : trigger.conditions;
                const emails = typeof trigger.emails === 'string' ? JSON.parse(trigger.emails) : trigger.emails;

                document.getElementById('triggerName').value = trigger.name || '';
                document.getElementById('triggerSentiment').value = conditions.sentiment || 'all';
                document.getElementById('triggerRelevance').value = conditions.relevance_score_min || 0.3;
                document.getElementById('triggerSources').value = conditions.sources ? conditions.sources.join(', ') : '';
                document.getElementById('triggerLanguage').value = conditions.language || 'all';
                document.getElementById('triggerCooldown').value = trigger.cooldown_minutes || 60;
                document.getElementById('triggerMaxPosts').value = trigger.max_posts_per_email || 10;
                document.getElementById('triggerEnabled').checked = trigger.enabled !== false;

                emailList = Array.isArray(emails) ? emails : [];
                updateEmailTags();
            } catch (error) {
                showToast('Error loading trigger', 'error');
                console.error(error);
            }
        }


        function updateEmailTags() {
            const container = document.getElementById('emailTags');
            if (!container) return;

            if (emailList.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = emailList.map(email => `
                <span class="email-tag">
                    ${escapeHtml(email)}
                    <button type="button" class="email-tag-remove" onclick="removeEmail('${escapeHtml(email)}')" title="Retirer">√ó</button>
                </span>
            `).join('');
        }

        window.saveTrigger = async function(event) {
            event.preventDefault();

            if (emailList.length === 0) {
                showToast('Add at least one email address', 'error');
                return;
            }

            const conditions = {
                sentiment: document.getElementById('triggerSentiment').value,
                relevance_score_min: parseFloat(document.getElementById('triggerRelevance').value) || 0.3
            };

            const sources = document.getElementById('triggerSources').value.trim();
            if (sources) {
                conditions.sources = sources.split(',').map(s => s.trim()).filter(Boolean);
            }

            const language = document.getElementById('triggerLanguage').value;
            if (language !== 'all') {
                conditions.language = language;
            }

            const triggerData = {
                name: document.getElementById('triggerName').value.trim(),
                conditions: conditions,
                emails: emailList,
                cooldown_minutes: parseInt(document.getElementById('triggerCooldown').value) || 60,
                max_posts_per_email: parseInt(document.getElementById('triggerMaxPosts').value) || 10,
                enabled: document.getElementById('triggerEnabled').checked
            };

            try {
                const url = currentTriggerId 
                    ? `${API_BASE}/api/email/triggers/${currentTriggerId}`
                    : `${API_BASE}/api/email/triggers`;
                const method = currentTriggerId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(triggerData)
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error saving trigger');
                }

                showToast(currentTriggerId ? 'Trigger updated successfully' : 'Trigger created successfully', 'success');
                window.closeTriggerModal();
                loadEmailNotifications();
            } catch (error) {
                showToast(error.message || 'Error saving trigger', 'error');
                console.error(error);
            }
        };

        // Setup modal event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Close modal on overlay click
            const modal = document.getElementById('triggerModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        window.closeTriggerModal();
                    }
                });
            }

            // Allow Enter key in email input to add email
            const emailInput = document.getElementById('triggerEmailInput');
            if (emailInput) {
                emailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        window.addEmail();
                    }
                });
            }
        });

        window.toggleTrigger = async function(triggerId, newStatus) {
            try {
                const res = await fetch(`${API_BASE}/api/email/triggers/${triggerId}/toggle`, { method: 'POST' });
                if (res.ok) {
                    showToast(`Trigger ${newStatus ? 'enabled' : 'disabled'}`, 'success');
                    loadEmailNotifications();
                } else {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error updating trigger');
                }
            } catch (error) {
                showToast(error.message || 'Error updating trigger', 'error');
                console.error(error);
            }
        };

        window.deleteTrigger = async function(triggerId) {
            if (!confirm('Are you sure you want to delete this trigger?')) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/email/triggers/${triggerId}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('Trigger deleted', 'success');
                    loadEmailNotifications();
                } else {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error deleting trigger');
                }
            } catch (error) {
                showToast(error.message || 'Error deleting trigger', 'error');
                console.error(error);
            }
        };

        window.editTrigger = async function(triggerId) {
            openTriggerModal(triggerId);
        };

        window.testEmailConnection = async function() {
            const input = document.getElementById('testEmailInput');
            const email = input ? input.value.trim() : '';
            
            if (!email) {
                showToast('Please enter an email address', 'error');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Invalid email address', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Testing...';

            try {
                const res = await fetch(`${API_BASE}/api/email/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient_email: email })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showToast(data.message || 'Test email sent successfully!', 'success');
                    if (input) input.value = ''; // Clear input on success
                } else {
                    throw new Error(data.detail || 'Test failed');
                }
            } catch (error) {
                showToast(`Test failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };

        // Define toggleHelpMenu function for settings page
        window.toggleHelpMenu = function() {
            const menu = document.getElementById('helpMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        };

        // Make toggleAccordion available globally
        window.toggleAccordion = function(id) {
            const accordion = document.querySelector(`[data-accordion="${id}"]`);
            if (!accordion) return;
            
            const header = accordion.querySelector('.accordion-header');
            const content = accordion.querySelector('.accordion-content');
            
            if (!header || !content) return;
            
            const isActive = header.classList.contains('active');
            
            if (isActive) {
                header.classList.remove('active');
                content.classList.remove('active');
            } else {
                header.classList.add('active');
                content.classList.add('active');
            }
            
            // Save state to localStorage
            const state = {};
            document.querySelectorAll('.accordion').forEach(acc => {
                const accId = acc.getAttribute('data-accordion');
                const accHeader = acc.querySelector('.accordion-header');
                state[accId] = accHeader && accHeader.classList.contains('active');
            });
            localStorage.setItem('settingsAccordionState', JSON.stringify(state));
        };

        // Make toggleThemeFromSettings available globally
        window.toggleThemeFromSettings = function() {
            if (window.toggleTheme) {
                window.toggleTheme();
            }
            const toggle = document.getElementById('themeToggle');
            if (toggle) {
                const isDark = document.body.classList.contains('dark-mode');
                if (isDark) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        };

        // Close help menu when clicking outside (only if menu is open)
        document.addEventListener('click', (e) => {
            const helpMenu = document.getElementById('helpMenu');
            if (!helpMenu) return;
            
            const helpTab = document.querySelector('.nav-tab[onclick*="toggleHelpMenu"]');
            const isClickInsideMenu = helpMenu.contains(e.target);
            const isClickOnTab = helpTab && helpTab.contains(e.target);
            
            if (helpMenu.classList.contains('active') && !isClickInsideMenu && !isClickOnTab) {
                helpMenu.classList.remove('active');
            }
        });
    </script>
    <script type="module" src="/dashboard/js/version-loader.js"></script>
    <script src="/js/logo-updater.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Feedbacks Tracker - Analyst View</title>
    <link rel="stylesheet" href="/css/shared-theme.css">
    <link rel="stylesheet" href="/dashboard/css/styles.css">
    <link rel="stylesheet" href="/dashboard/css/navigation.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="has-nav-menu">
    <!-- Navigation Menu -->
    <nav class="nav-menu">
        <div class="nav-menu-left">
            <a href="/dashboard" class="nav-logo">
                <img src="/assets/logo/ovhcloud-logo.svg" alt="OVHcloud" class="ovh-logo" style="width: 32px; height: 32px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <svg class="ovh-logo" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                    <circle cx="60" cy="60" r="55" fill="none" stroke="#123f6d" stroke-width="4"/>
                    <path d="M 35 60 Q 60 35, 85 60 Q 60 85, 35 60" fill="#123f6d"/>
                    <path d="M 25 60 Q 35 50, 45 60 Q 55 70, 65 60 Q 75 50, 85 60 Q 95 70, 105 60" 
                          stroke="#00d4ff" stroke-width="3" fill="none" stroke-linecap="round"/>
                </svg>
                <span>Customer Feedbacks Tracker</span>
            </a>
            <div class="nav-tabs">
                <a href="/scraping" class="nav-tab">
                    <span class="nav-tab-icon">‚öôÔ∏è</span>
                    <span>Feedbacks Collection</span>
                </a>
                <a href="/dashboard" class="nav-tab active">
                    <span class="nav-tab-icon">üìä</span>
                    <span>Dashboard Analytics</span>
                </a>
                <a href="/improvements" class="nav-tab">
                    <span class="nav-tab-icon">üí°</span>
                    <span>Improvements Opportunities</span>
                </a>
                <a href="/settings" class="nav-tab">
                    <span class="nav-tab-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
                <a href="/logs" class="nav-tab">
                    <span class="nav-tab-icon">üìã</span>
                    <span>Scraping Logs</span>
                </a>
                <a href="#" class="nav-tab" onclick="event.preventDefault(); toggleHelpMenu(); return false;">
                    <span class="nav-tab-icon">‚ùì</span>
                    <span>Help</span>
                </a>
            </div>
        </div>
        <div class="nav-menu-right">
            <span class="version-badge" id="versionBadge" title="Application version">v1.0.1</span>
            <button class="theme-toggle" id="themeToggleBtn" title="Toggle theme">üåì</button>
        </div>
    </nav>

    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <div class="logo-container">
                <img src="/assets/logo/ovhcloud-logo.svg" alt="OVHcloud" class="ovh-logo" style="width: 48px; height: 48px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <svg class="ovh-logo" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                    <!-- Fallback SVG if image fails to load -->
                    <circle cx="60" cy="60" r="55" fill="none" stroke="#123f6d" stroke-width="4"/>
                    <path d="M 35 60 Q 60 35, 85 60 Q 60 85, 35 60" fill="#123f6d"/>
                    <path d="M 25 60 Q 35 50, 45 60 Q 55 70, 65 60 Q 75 50, 85 60 Q 95 70, 105 60" 
                          stroke="#00d4ff" stroke-width="3" fill="none" stroke-linecap="round"/>
                </svg>
                <span class="logo-text">OVHcloud Analyst View</span>
            </div>
            <h1 class="main-title">Customer Feedbacks Tracker</h1>
        </div>
        <div class="header-right">
            <div class="search-container">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" id="globalSearch" placeholder="Search by product, keyword, review, post, sources..." class="search-input">
                <div class="search-info-tooltip" id="searchInfoTooltip">
                    <svg class="info-icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    <div class="tooltip-content">
                        <strong>Recherche et filtres multiples</strong>
                        <p>‚Ä¢ La recherche fonctionne sur le contenu, l'auteur, l'URL et la source</p>
                        <p>‚Ä¢ Vous pouvez combiner plusieurs filtres : sentiment, langue, produit, dates</p>
                        <p>‚Ä¢ Les filtres s'appliquent simultan√©ment (ET logique)</p>
                        <p>‚Ä¢ Cliquez sur un produit dans "Distribution per Product" pour filtrer</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-primary" id="scrapeAllBtn">üÜï Scrape New Data</button>
                <button class="btn-secondary" id="resetFiltersBtn">Reset Filters</button>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="dashboard-main">
        <!-- Date Slicer - Common Date Filter for All Charts -->
        <section class="panel-date-slicer">
            <div class="date-slicer-content">
                <div class="date-slicer-label">
                    <svg class="date-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span>Date Range (applies to all charts)</span>
                </div>
                <div class="date-slicer-inputs">
                    <input type="date" id="globalDateFrom" class="date-input" title="From Date">
                    <span class="date-separator">to</span>
                    <input type="date" id="globalDateTo" class="date-input" title="To Date">
                    <button class="btn-clear-dates" id="clearDatesBtn" title="Clear date filters">‚úï</button>
                </div>
                <button class="btn-clear-all-filters" id="clearAllFiltersBtn" title="Clear all filters">
                    <svg class="clear-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                    Clear All Filters
                </button>
            </div>
        </section>

        <!-- What's Happening Section -->
        <section class="panel-whats-happening">
            <div class="whats-happening-header">
                <h2>‚ö†Ô∏è What's Happening</h2>
                <div class="stats-cards" id="statsCards">
                    <!-- Will be populated by JS -->
                </div>
                <button class="btn-critical-posts" id="openCriticalPostsBtn" style="display: none;">
                    üëâ Open critical posts (<span id="criticalPostsCount">0</span>)
                </button>
            </div>
            <div class="whats-happening-content" id="whatsHappeningContent">
                <!-- Will be populated by JS -->
            </div>
            <div class="recommended-actions" id="recommendedActions">
                <!-- Will be populated by JS -->
            </div>
        </section>

        <!-- Left Panel: Timeline & Histogram -->
        <section class="panel-left">
            <div class="panel-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h2>Timeline & Histogram</h2>
                    <span style="font-size: 0.85em; color: var(--text-secondary); font-style: italic;" title="Cliquez sur une barre pour filtrer par date. Glissez-d√©posez pour s√©lectionner une plage de dates.">
                        üí° Cliquez ou glissez pour filtrer
                    </span>
                </div>
                <div class="panel-filters">
                    <button class="filter-btn active" data-filter="all">All Posts</button>
                    <select class="filter-select" id="sentimentFilter">
                        <option value="all">All Sentiment</option>
                        <option value="positive">Positive</option>
                        <option value="negative">Negative</option>
                        <option value="neutral">Neutral</option>
                    </select>
                    <select class="filter-select" id="languageFilter">
                        <option value="all">All Language</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="en">English</option>
                    </select>
                    <select class="filter-select" id="productFilter">
                        <option value="all">All Products</option>
                    </select>
                    <input type="date" id="dateFrom" class="filter-select" title="From Date" placeholder="From" style="min-width: 140px;">
                    <input type="date" id="dateTo" class="filter-select" title="To Date" placeholder="To" style="min-width: 140px;">
                    <button id="clearTimelineFilterBtn" class="filter-btn" style="background: #ef4444; color: white; margin-left: 8px;" title="Reset timeline to default (last 12 months)">Clear Filter</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="timelineChart"></canvas>
            </div>
        </section>

        <!-- Right Panel: Distribution by Product -->
        <section class="panel-right">
            <div class="panel-header">
                <h2>Distribution per Product</h2>
                <div class="panel-actions">
                    <span class="top-indicator">Top 5</span>
                    <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                </div>
            </div>
            <div class="product-list" id="productList">
                <!-- Will be populated by JS -->
            </div>
            <div class="product-nav">
                <button class="nav-btn" id="showMoreProductsBtn">+ 12 Other Products</button>
                <div class="nav-arrows">
                    <button class="arrow-btn" id="navigateProductsPrevBtn">‚Üê</button>
                    <button class="arrow-btn" id="navigateProductsNextBtn">‚Üí</button>
                </div>
            </div>
        </section>

        <!-- Posts by Source Panel -->
        <section class="panel-source">
            <div class="panel-header">
                <h2>üìä Posts by Source</h2>
                <div class="panel-actions">
                    <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                </div>
            </div>
            <div class="chart-container-source">
                <canvas id="sourceChart"></canvas>
            </div>
        </section>

        <!-- Sentiment Distribution Panel -->
        <section class="panel-sentiment">
            <div class="panel-header">
                <h2>üí≠ Sentiment Distribution</h2>
                <div class="panel-actions">
                    <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                </div>
            </div>
            <div class="chart-container-sentiment">
                <canvas id="sentimentChart"></canvas>
            </div>
        </section>

        <!-- World Map Panel (Hidden by default, can be toggled) -->
        <section class="panel-map" style="display: none;">
            <div class="panel-header">
                <h2>üåç Posts by Country</h2>
                <div class="panel-actions">
                    <div class="map-legend" id="mapLegend">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>
            <div class="map-container" id="worldMap">
                <!-- Leaflet map will be rendered here -->
            </div>
        </section>

        <!-- Bottom Panel: Posts to Address -->
        <section class="panel-bottom">
            <div class="panel-header">
                <h2>Posts to Address (Recent & Critical)</h2>
                <div class="panel-actions">
                    <select class="sort-select" id="sortSelect">
                        <option value="recent">Most Recent</option>
                        <option value="critical">Most Critical</option>
                        <option value="engagement">Highest Engagement</option>
                    </select>
                    <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M7 12h10M11 18h2"/>
                    </svg>
                </div>
            </div>
            <div class="posts-list" id="postsList">
                <!-- Will be populated by JS -->
            </div>
        </section>
    </main>


    <!-- Version Switch Modal -->
    <div id="versionModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="closeVersionModalBtn" class="modal-close">√ó</button>
            <h2 style="color: var(--accent-primary); margin-bottom: 20px;">üîÑ Switch UI Version</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Choose which version of the UI you want to use:
            </p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button id="switchToV1Btn" class="version-btn" style="background: #00d4ff;">
                    üì± Version 1 (Classic)
                </button>
                <button id="switchToV2Btn" class="version-btn" style="background: #34d399;">
                    üöÄ Version 2 (Analyst View)
                </button>
            </div>
            <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 20px; text-align: center;">
                The page will reload after switching.
            </p>
        </div>
    </div>

    <!-- Inline script to define functions immediately -->
    <script>
        // Define placeholder functions immediately to prevent errors
        window.openVersionModal = function() {
            console.log('openVersionModal called - waiting for module to load...');
        };
        window.closeVersionModal = function() {
            console.log('closeVersionModal called - waiting for module to load...');
        };
        window.switchToVersion = function(version) {
            console.log('switchToVersion called - waiting for module to load...', version);
        };
        window.toggleTheme = function() {
            console.log('toggleTheme called - waiting for module to load...');
        };
        window.toggleHelpMenu = function() {
            const menu = document.getElementById('helpMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        };
    </script>
    
    <!-- Help Menu -->
    <div class="help-menu" id="helpMenu">
        <div class="help-menu-header">
            <h2>üìñ Help & Information</h2>
            <button class="help-menu-close" onclick="toggleHelpMenu()">√ó</button>
        </div>
        <div class="help-menu-content">
            <h3>üí¨ Customer Feedbacks Tracker</h3>
            <p>
                <strong>Dashboard Analytics</strong> provides visual insights and real-time analysis of customer feedback across all OVH products and services.
            </p>

                <h3>üìä Dashboard Sections</h3>
                <ul>
                    <li><strong>üìà Statistics Banner:</strong> Overview of total posts, positive, negative, and neutral feedback</li>
                    <li><strong>‚ö†Ô∏è What's Happening:</strong> Real-time alerts, insights, and AI-generated recommended actions</li>
                    <li><strong>üìÖ Timeline & Histogram:</strong> Visual timeline of feedback over time with interactive filtering</li>
                    <li><strong>üìä Distribution per Product:</strong> Breakdown of feedback by OVH product category</li>
                    <li><strong>üìù Posts to Address:</strong> Critical and recent posts requiring attention</li>
                </ul>

                <h3>üéØ Interactive Features</h3>
                <ul>
                    <li><strong>Timeline Click:</strong> Click on a bar to filter posts by that date</li>
                    <li><strong>Timeline Double-Click:</strong> Double-click a bar to filter by date AND the most frequent product for that date</li>
                    <li><strong>Product Click:</strong> Click on a product in "Distribution per Product" to filter all posts by that product</li>
                    <li><strong>Clear Filters:</strong> Use the "Clear Product Filter" button or reset filters to remove active filters</li>
                    <li><strong>Critical Posts:</strong> Click "Open critical posts (X)" to filter and scroll to critical posts</li>
                </ul>

                <h3>üîç Filtering Options</h3>
                <ul>
                    <li><strong>Global Search:</strong> Search across all post content (supports multiple keywords separated by spaces)</li>
                    <li><strong>Sentiment Filter:</strong> Filter by positive, negative, or neutral sentiment</li>
                    <li><strong>Language Filter:</strong> Filter by French, English, or other languages</li>
                    <li><strong>Product Filter:</strong> Filter by specific OVH product categories</li>
                    <li><strong>Date Range:</strong> Use timeline interaction or date inputs to filter by date</li>
                    <li><strong>Sort Options:</strong> Sort posts by date, sentiment, or source</li>
                </ul>

                <h3>ü§ñ AI-Powered Features</h3>
                <p>
                    If LLM API keys are configured (in Feedbacks Collection page):
                </p>
                <ul>
                    <li><strong>Recommended Actions:</strong> AI-generated actionable recommendations based on recent feedback patterns</li>
                    <li><strong>Priority Levels:</strong> Actions are prioritized as High, Medium, or Low based on impact</li>
                    <li><strong>Dynamic Insights:</strong> Real-time analysis of feedback trends and spikes</li>
                </ul>

                <h3>üìä What's Happening Section</h3>
                <ul>
                    <li><strong>Alerts:</strong> Automatic detection of negative feedback spikes (230%+ increase)</li>
                    <li><strong>Insights:</strong> Identification of top impacted products and most frequent issues</li>
                    <li><strong>Recommended Actions:</strong> AI-generated or rule-based improvement suggestions</li>
                    <li><strong>Critical Posts Button:</strong> Quick access to filter and view critical posts</li>
                </ul>

                <h3>üìà Charts & Visualizations</h3>
                <ul>
                    <li><strong>Timeline Chart:</strong> Bar chart showing post distribution over time</li>
                    <li><strong>Product Distribution:</strong> Pie/bar chart showing feedback distribution across products</li>
                    <li><strong>Interactive Tooltips:</strong> Hover over chart elements for detailed information</li>
                    <li><strong>Show More Products:</strong> Expand to see all products beyond the top 5</li>
                </ul>

                <h3>üé® Navigation</h3>
                <ul>
                    <li><strong>üì• Feedbacks Collection:</strong> Manage keywords, LLM settings, and launch scrapers</li>
                    <li><strong>üìä Dashboard Analytics:</strong> Current page - visual analytics and insights</li>
                    <li><strong>üí° Improvements Opportunities:</strong> Pain points analysis and opportunity scoring</li>
                    <li><strong>‚ùì Help:</strong> This menu - access help and documentation</li>
                    <li><strong>üåì Theme Toggle:</strong> Switch between light and dark mode</li>
                </ul>

                <h3>üí° Pro Tips</h3>
                <ul>
                    <li>Use the timeline to identify feedback trends and spikes</li>
                    <li>Double-click timeline bars to quickly filter by product and date</li>
                    <li>Configure LLM keys to unlock AI-powered recommended actions</li>
                    <li>Click on products to focus analysis on specific areas</li>
                    <li>Use the critical posts button to prioritize urgent issues</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Modules -->
    <script type="module" src="/dashboard/js/api.js"></script>
    <script type="module" src="/dashboard/js/state.js"></script>
    <script type="module" src="/dashboard/js/dashboard.js"></script>
    <script type="module" src="/dashboard/js/charts.js"></script>
    <script type="module" src="/dashboard/js/world-map.js"></script>
    <script type="module" src="/dashboard/js/version-switch.js"></script>
    <script type="module" src="/dashboard/js/app.js"></script>
    <script>
        // Close help menu when clicking outside
        document.addEventListener('click', (e) => {
            const helpMenu = document.getElementById('helpMenu');
            const helpTab = document.querySelector('.nav-tab[onclick*="toggleHelpMenu"]');
            if (helpMenu && helpTab && 
                !helpMenu.contains(e.target) && 
                !helpTab.contains(e.target) &&
                helpMenu.classList.contains('active')) {
                helpMenu.classList.remove('active');
            }
        });
    </script>
</body>
</html>

